<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="awaken_ing">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
<link href='/assets/stylesheets/bootstrap.min-cda5ce8bd759b8186e71e4929410abbf.css' type='text/css' rel='stylesheet' media='all'>
<link href='/assets/stylesheets/style-e81fa375b231bedf6cb2dbc6653570cc.css' type='text/css' rel='stylesheet' media='all'>
<link href='/assets/stylesheets/google_prettify/sons-of-obsidian-afb0925bfa2d994f17dab93e13fbf999.css' type='text/css' rel='stylesheet' media='all'>
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container-narrow">
          <a class="brand" href="/">HOMEPAGE</a>
          <ul class="nav">
              
                <li><a href="/archive">Archive</a></li>
              
              
                <li><a href="/tags">Tags</a></li>
              
              
                <li><a href="/categories">Categories</a></li>
              
              
                <li><a href="/pages">Pages</a></li>
              
              
                <li><a href="/about-me">About Me</a></li>
              
          </ul>
        </div>
      </div>
    </div>

    <div class="container-narrow">

      <div class="content">
        <div class="row-fluid">
  <div class="span12">
      <div class="posts">
        <h3 class="title"><a href="/posts/mm/reclaim_01_overview">page reclaim 01:概述</a> <span class="date">2017-02-07</span></h3>

        <div class="summary ellipsis">
<h1 id="toc_0"><h4>1. 背景/问题引入</h4></h1>

<p>本文不讨论 swapping (swap out to disk).  </p>

<p>If a seldom-used page is backed by a block device (e.g., memory mappings
of files) then the modified pages need not be swapped out, but can be directly synchronized with the block device. The page frame can be reused, and if the data are required again, it can be reconstructed from the source. If a page is backed by a file but cannot be modified in memory (e.g., binary executable data), then it can be discarded if it is currently not required.
通过Writing back cached data即可将这些page释放.</p>

<p>If a page is backed by a file but cannot be modified in memory (e.g., binary executable data), then it can be discarded if it is currently not required. </p>

<p>将 暂时不用的 或 很少使用的  内存回笼/回收, 给后续其他人使用. 那么, 如何界定 暂时不用 或 很少使用 呢? 这些已分配出去的内存都散落在哪里?</p>

<h1 id="toc_1"><h4>2. 散落在哪</h4></h1>

<p>如何找到这些内存呢? 啥链表吗?<br>
答:see add_to_page_cache_lru(), page_add_new_anon_rmap()</p>

<p>方式1:
add_to_page_cache_lru 把page添加到 both the page cache and the LRU cache. 
Most importantly, it is used by mpage_readpages and do_generic_mapping_read, the standard functions in which the block layer ends up when reading data from a file or mapping.
当然, 实际是先添加到per cpu的struct pagevec中, 等满了再转移到global的lru中.</p>
</div>

        <div class="more">
          <a href="/posts/mm/reclaim_01_overview" class="btn btn-small">read more..</a>
        </div>
      </div>
      <div class="posts">
        <h3 class="title"><a href="/posts/mm/reclaim_02_implement">page reclaim 02:实现</a> <span class="date">2017-02-07</span></h3>

        <div class="summary ellipsis">
<p>本文简化描述, 忽略compound page, 忽略HUGEPAGE, 未开启CONFIG_MEMCG, 未开启CONFIG_SWAP.
若无特别说明, 本文仅讨论ARM体系的情况.</p>

<h1 id="toc_0"><h4>1. 数据结构</h4></h1>

<p>per zone : active list, inactive list</p>

<pre><code>struct zone {
    struct lruvec       lruvec;
};

struct lruvec {
    struct list_head lists[NR_LRU_LISTS];
    ...
};
</code></pre>

<p>per node :kswapd  </p>

<pre><code>kswapd_init -&gt; for_each_node_state(nid, N_MEMORY) kswapd_run(nid)
kswapd_run -&gt; pgdat-&gt;kswapd = kthread_run(kswapd, pgdat, "kswapd%d", nid);
</code></pre>
</div>

        <div class="more">
          <a href="/posts/mm/reclaim_02_implement" class="btn btn-small">read more..</a>
        </div>
      </div>
      <div class="posts">
        <h3 class="title"><a href="/posts/mm/reclaim_04_parameter">page reclaim 04:参数</a> <span class="date">2017-02-07</span></h3>

        <div class="summary ellipsis">
<p>未开启CONFIG_MEMCG, CONFIG_SWAP.</p>

<h1 id="toc_0"><h4>1. scan_control</h4></h1>

<p>linux-3.10.86/mm/vmscan.c</p>

<pre><code>struct scan_control {

    /* Incremented by the number of inactive pages that were scanned */
    unsigned long nr_scanned;

    /* How many pages shrink_list() should reclaim 
    问题:nr_to_reclaim和nr_scanned的关系?
    答:nr_to_reclaim是个setting data, nr_reclaimed是runtime date.
    通常是先给struct scan_control sc设置好这个目标, 
    然后启动回收. 
    在 sum of shrink_list() &gt; nr_to_reclaim后中断回收, see shrink_lruvec() or do_try_to_free_pages().
    */
    unsigned long nr_to_reclaim;

    /*
    这里的may类似may I ..., may的意思是 是否可以, 是否允许
    */
    int may_writepage;

    /*
    [Understanding the Linux Kernel, 3rd Edition]p695
    Lower priority implies scanning more pages.
    */
    int priority;

};

get_scan_count
{
        size = get_lru_size(lruvec, lru);
        scan = size &gt;&gt; sc-&gt;priority;
        //扫描的量 与 list的大小 成比例
}

shrink_lruvec
|--//1. 根据优先级等 给数组nr[]赋值
|--get_scan_count(lruvec, sc, nr); 
</code></pre>
</div>

        <div class="more">
          <a href="/posts/mm/reclaim_04_parameter" class="btn btn-small">read more..</a>
        </div>
      </div>
      <div class="posts">
        <h3 class="title"><a href="/posts/arm/arm_asid">arm linux的ASID (Address Space ID)</a> <span class="date">2017-01-18</span></h3>

        <div class="summary ellipsis">
<p>
来自本人的旧博客 http://blog.163.com/awaken_ing/blog/static/1206131972015112011286335
</p>

<p>平台:ARM Versatile Express for Cortex-A9 (ARMv7)<br>
 # CONFIG_ARM_LPAE is not set, 也就是使用Short-descriptor格式, ASID存储在CONTEXTIDR的低8 bit:</p>

<pre><code>31                         7          0
+-------------------------+-----------+
|      PROCID             |   ASID    |
+-------------------------+-----------+
</code></pre>

<p>页表项中 nG == 1时, 这个页表项信息就是 non-global, 或者说 process-specific, 对应的TLB中就会有ASID信息, 执行虚拟地址到物理地址转换时, ASID也需要参与该过程.</p>

<p>用户地址空间的页表才会设置nG标志 (内核地址的一部分地址范围使用TLB lockdown比较合适):
linux-3.10.86/arch/arm/include/asm/pgtable.h</p>

<pre><code>static inline void set_pte_at(struct mm_struct *mm, unsigned long addr, 
                  pte_t *ptep, pte_t pteval) 
{ 
...
    if (addr &lt; TASK_SIZE &amp;&amp; pte_present_user(pteval)) { 
... 
        ext |= PTE_EXT_NG; 
    } 
... 
    set_pte_ext(ptep, pteval, ext); 
}

set_pte_at -&gt; set_pte_ext -&gt; cpu_v7_set_pte_ext
</code></pre>
</div>

        <div class="more">
          <a href="/posts/arm/arm_asid" class="btn btn-small">read more..</a>
        </div>
      </div>
      <div class="posts">
        <h3 class="title"><a href="/posts/arm/interrupt_softirq_in_arm">中断, softirq, tasklet的区别</a> <span class="date">2017-01-18</span></h3>

        <div class="summary ellipsis">
<h1 id="toc_0"><h4>1. 中断流程</h4></h1>

<p>假定 CONFIG_MULTI_IRQ_HANDLER=y, handle_arch_irq 为 gic_handle_irq.<br>
linux-3.10.86/arch/arm/kernel/setup.c</p>

<pre><code>__irq_svc @entry-armv.S
|   |--svc_entry    保存spsr_&lt;exception&gt; 到r5
|   |--irq_handler
|   |   |--handle_arch_irq =&gt; gic_handle_irq
|   |   |   |--irq_find_mapping  完成 an hw irq number到a linux irq的转换
|   |   |   |--handle_IRQ(irqnr, regs) if not IPI 
|   |   |   |       |--generic_handle_irq  -&gt; generic_handle_irq_desc -&gt; handle_fasteoi_irq
|   |   |   |       |   |--raw_spin_lock(&amp;desc-&gt;lock);
|   |   |   |       |   |--handle_irq_event
|   |   |   |       |   |   |--raw_spin_unlock(&amp;desc-&gt;lock);
|   |   |   |       |   |   |--handle_irq_event_percpu -&gt; action-&gt;handler
|   |   |   |       |   |   |--raw_spin_lock(&amp;desc-&gt;lock);
|   |   |   |       |   |--chip-&gt;irq_eoi
|   |   |   |       |   |--raw_spin_unlock(&amp;desc-&gt;lock);
|   |   |   |       |--irq_exit();  这里中断还是禁用的吗? 答:是的, ifndef __ARCH_IRQ_EXIT_IRQS_DISABLED
|   |   |   |       |   |--WARN_ON_ONCE(!irqs_disabled());
|   |   |   |       |   |--if( ... ) invoke_softirq() 
|   |   |   |       |   |    |--do_softirq -&gt; __do_softirq
|   |   |   |       |   |    |    |--local_irq_enable   //修改CPSR I bit, 打开中断
|   |   |   |       |   |    |    |--h-&gt;action(h)
|   |   |   |       |   |    |    |--local_irq_disable  //这里为何又禁止中断???
|   |   |   |       |--set_irq_regs(old_regs)  这里开启中断? 答:不是.
|   |--svc_exit r5, irq = 1  @entry-header.S
</code></pre>
</div>

        <div class="more">
          <a href="/posts/arm/interrupt_softirq_in_arm" class="btn btn-small">read more..</a>
        </div>
      </div>
    
    <div class="pagination">
      <ul>
          <li><a href="/posts/index/1">1</a></li>
          <li><a href="/posts/index/2">2</a></li>
          <li class="active"><a href="/posts/index/3">3</a></li>
          <li><a href="/posts/index/4">4</a></li>
          <li><a href="/posts/index/5">5</a></li>
          <li><a href="/posts/index/6">6</a></li>
          <li><a href="/posts/index/7">7</a></li>
          <li><a href="/posts/index/8">8</a></li>
          <li><a href="/posts/index/9">9</a></li>
      </ul>
    </div>
  </div>
</div>

      </div>

      <hr>
      <div class="footer">
        <p> Published with <a href="http://ruhoh.com" target="_blank" title="The Definitive Technical Blogging Framework">ruhoh</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </div>

    </div> <!-- /container -->

    
    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-89949508-1']);
  _gaq.push(['_trackPageview']);
  

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


    
  </body>
</html>
